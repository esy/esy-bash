---
# Cross-platform set of build steps for building esy projects

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '18.16.0'
  - bash: |
      NPM_CACHE_DIR=$(npm config get cache)
      ESY_BASH_VERSION=$(node -e 'console.log(require("./package.json").version)')
      echo "##vso[task.setvariable variable=NPM_CACHE_DIR]$NPM_CACHE_DIR"
      echo "##vso[task.setvariable variable=ESY_BASH_VERSION]$ESY_BASH_VERSION"
    displayName: Compute pipeline variables
  - task: Cache@2
    inputs:
      key: 'npm | "$(Build.SourcesDirectory)/package-lock.json"'
      restoreKeys: |
         npm
      path: $(NPM_CACHE_DIR)
    displayName: Cache NPM

  - script: npm install
  - script: npm run build-cygwin
    displayName: 'Build cygwin'
  - script: npm run package-cygwin
    displayName: "Package cygwin"
  - bash: npm pack
    displayName: "npm pack"
  - task: PublishBuildArtifacts@1
    displayName: 'Release Package'
    inputs:
        PathtoPublish: './esy-bash-$(ESY_BASH_VERSION).tgz'
        ArtifactName: esy-bash-$(ESY_BASH_VERSION)
  - script: node postinstall.js
    displayName: "node postinstall.js (iteration 1)"
  # TODO Figure e2e test
